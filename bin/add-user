#!/usr/bin/env php
<?php
require __DIR__ . '/../vendor/autoload.php';

if ($argc < 3) {
    fwrite(STDERR, "Usage: php add-user <file> <username> [password]\n");
    exit(1);
}

$file = $argv[1];
$user = $argv[2];
$pass = $argv[3] ?? null;
if ($pass === null) {
    fwrite(STDOUT, "Password: ");
    $pass = trim(fgets(STDIN));
}
$hash = password_hash($pass, PASSWORD_DEFAULT);

if (!is_dir(dirname($file))) {
    mkdir(dirname($file), 0777, true);
}
file_put_contents($file, "$user:$hash\n", FILE_APPEND | LOCK_EX);

echo "Added $user to $file\n";

